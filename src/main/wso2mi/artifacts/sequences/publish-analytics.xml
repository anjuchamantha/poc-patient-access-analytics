<?xml version="1.0" encoding="UTF-8"?>
<sequence name="publish-analytics" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log category="INFO" logMessageID="false" logFullPayload="false">
        <message>[SEQUENCE] publish-analytics ---------</message>
    </log>
    <property
        expression="get-property('_OH_INTERNAL_SECURITY_JWT_http://wso2.org/claims/patientId')"
        name="patient_id" scope="default" type="STRING" />
    <property
        expression="get-property('_OH_INTERNAL_SECURITY_JWT_http://wso2.org/claims/apiname')"
        name="api_name" scope="default" type="STRING" />
    <property
        expression="get-property('_OH_INTERNAL_SECURITY_JWT_http://wso2.org/claims/applicationid')"
        name="application_id" scope="default" type="STRING" />
    <property
        expression="get-property('_OH_INTERNAL_SECURITY_JWT_http://wso2.org/claims/applicationname')"
        name="application_name" scope="default" type="STRING" />
    <property
        expression="get-property('_OH_INTERNAL_SECURITY_JWT_http://wso2.org/claims/applicationUUId')"
        name="application_uuid" scope="default" type="STRING" />
    <log category="INFO" level="custom">
        <property expression="$ctx:patient_id" name="patient_id" />
    </log>

    <!-- Build dynamic query string based on non-null values -->
    <property name="query_params" value="" scope="default" type="STRING" />

    <!-- Always add resource_type if api_name is not null -->
    <filter xpath="$ctx:api_name != '' and $ctx:api_name != 'null'">
        <then>
            <property expression="concat('resource_type=', $ctx:api_name)" name="query_params"
                scope="default" type="STRING" />
        </then>
    </filter>

    <!-- Add patient_id if not null -->
    <filter xpath="$ctx:patient_id != '' and $ctx:patient_id != 'null'">
        <then>
            <filter xpath="$ctx:query_params != ''">
                <then>
                    <property
                        expression="concat($ctx:query_params, '&amp;patient_id=', $ctx:patient_id)"
                        name="query_params" scope="default" type="STRING" />
                </then>
                <else>
                    <property expression="concat('patient_id=', $ctx:patient_id)"
                        name="query_params" scope="default" type="STRING" />
                </else>
            </filter>
        </then>
    </filter>

    <!-- Add application_uuid if not null -->
    <filter xpath="$ctx:application_uuid != '' and $ctx:application_uuid != 'null'">
        <then>
            <filter xpath="$ctx:query_params != ''">
                <then>
                    <property
                        expression="concat($ctx:query_params, '&amp;app_id=', $ctx:application_uuid)"
                        name="query_params" scope="default" type="STRING" />
                </then>
                <else>
                    <property expression="concat('app_id=', $ctx:application_uuid)"
                        name="query_params" scope="default" type="STRING" />
                </else>
            </filter>
        </then>
    </filter>

    <!-- Add status_code (you might want to make this dynamic too) -->
    <property name="status_code" value="200" scope="default" type="STRING" />
    <filter xpath="$ctx:query_params != ''">
        <then>
            <property expression="concat($ctx:query_params, '&amp;status_code=', $ctx:status_code)"
                name="query_params" scope="default" type="STRING" />
        </then>
        <else>
            <property expression="concat('status_code=', $ctx:status_code)" name="query_params"
                scope="default" type="STRING" />
        </else>
    </filter>

    <!-- Build final URL -->
    <property
        expression="concat('http://localhost:8290/services/MIAnalyticsDataService/publish?', $ctx:query_params)"
        name="uri.var.final_url" scope="default" type="STRING" />

    <log category="INFO" level="custom">
        <property expression="$ctx:uri.var.final_url" name="final_url" />
    </log>

    <call blocking="false">
        <endpoint>
            <http method="get" uri-template="{uri.var.final_url}" />
        </endpoint>
    </call>
</sequence>
